import{n as J,d as L,r as g,p as U,q as P,s as R,c as h,b as t,w as i,e as w,i as n,t as W,f as p,F as q,v as G,x as _,y as j,z as Q,A as X,h as S,B as Y,C as Z,D as ee,G as te,H as se,I as z,J as B,E as I,o as v,K as oe,_ as ne}from"./index-CV45lKxV.js";const ae=J("chat",{state:()=>({messages:[],isConnected:!1,socket:null}),actions:{initializeWebSocket(){const o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/ai/ws`;console.log("正在连接到 WebSocket:",o);try{this.socket=new WebSocket(o),this.socket.onopen=()=>{this.isConnected=!0,console.log("WebSocket 连接成功")},this.socket.onmessage=a=>{console.log("收到 WebSocket 消息:",a.data);try{const m=JSON.parse(a.data);this.addMessage({id:Date.now().toString(),content:m.content||"收到空消息",role:"assistant",timestamp:Date.now()})}catch(m){console.error("解析 WebSocket 消息失败:",m),this.addMessage({id:Date.now().toString(),content:typeof a.data=="string"?a.data:"收到无法解析的消息",role:"assistant",timestamp:Date.now()})}},this.socket.onclose=()=>{this.isConnected=!1,console.log("WebSocket 连接已断开"),setTimeout(()=>this.initializeWebSocket(),5e3)},this.socket.onerror=a=>{console.error("WebSocket 错误:",a),this.isConnected=!1}}catch(a){console.error("WebSocket 连接失败:",a),this.isConnected=!1}},sendMessage(c){const o={id:Date.now().toString(),content:c,role:"user",timestamp:Date.now()};if(this.addMessage(o),this.socket&&this.socket.readyState===WebSocket.OPEN){console.log("发送消息到 WebSocket:",c);try{const a=c+`

请给我txt格式的文本，不需要出现"*-#"符号`;this.socket.send(JSON.stringify({content:a})),console.log("发送真实消息到 WebSocket:",a)}catch(a){console.error("发送消息失败:",a)}}else console.warn("WebSocket 未连接，无法发送消息")},sendFormattedMessage(c){if(this.socket&&this.socket.readyState===WebSocket.OPEN)try{c.content&&(c.content=c.content+`

请给我txt格式的文本，不需要出现"*-#"符号`),this.socket.send(JSON.stringify(c)),console.log("发送带格式要求的消息到 WebSocket:",c)}catch(o){console.error("发送带格式要求的消息失败:",o)}else console.warn("WebSocket 未连接，无法发送消息")},addMessage(c){console.log("添加消息:",c),this.messages.push(c)},clearMessages(){this.messages=[]},disconnect(){this.socket&&(this.socket.close(),this.socket=null),this.isConnected=!1}}}),le={class:"chat-container"},ie={class:"chat-header"},ce={class:"connection-status"},re={key:0,class:"empty-state"},de={key:0,class:"attached-file"},ue=["innerHTML"],pe={class:"timestamp"},fe={key:2,class:"message ai-message typing-message"},me={class:"timestamp"},ge={class:"input-container"},he={key:0,class:"file-upload-container"},_e={class:"selected-file"},ve={class:"button-container"},ke=L({__name:"AIChatView",setup(c){const o=ae(),a=g(""),m=g(null),C=g(!1),b=g(!1),y=g(!1),M=g(null),r=g(null);U(()=>{o.initializeWebSocket(),console.log("组件已挂载，当前消息数量:",o.messages.length),o.messages.length===0&&setTimeout(()=>{o.addMessage({id:Date.now().toString(),content:"您好！我是AI教学助手，有什么可以帮助您的吗？",role:"assistant",timestamp:Date.now()})},1e3)}),P(()=>{o.disconnect(),M.value&&clearTimeout(M.value)}),R(()=>o.messages.length,(s,e)=>{console.log(`消息数量变化: ${e} -> ${s}`),B(()=>{F()})});const N=s=>{s&&s.raw&&(r.value=s.raw,console.log("文件已选择:",s.raw.name))},$=()=>{r.value=null},T=async()=>{if(!a.value.trim()&&!r.value)return;const s=a.value.trim();console.log("发送消息:",s);let e=s;if(r.value){const d=`<div class="attached-file">
      <strong>附件:</strong> ${r.value.name} (${x(r.value.size)})
    </div>`;e=e?`${e}<br>${d}`:d}let k=null;r.value&&(k={name:r.value.name,type:r.value.type,size:r.value.size}),o.addMessage({id:Date.now().toString(),content:e,role:"user",timestamp:Date.now(),file:k}),a.value="";const l=r.value;if(r.value=null,await B(),F(),o.isConnected){y.value=!0;try{const d={content:s};if(l)try{const u=await V(l);d.file={name:l.name,type:l.type,size:l.size,content:u}}catch(u){console.error("文件转换失败:",u),I.error("文件处理失败，但消息已发送")}o.sendFormattedMessage(d),M.value=window.setTimeout(()=>{y.value=!1},2e3)}catch(d){console.error("发送消息失败:",d),y.value=!1,I.error("发送消息失败，请稍后重试")}}},V=s=>new Promise((e,k)=>{const l=new FileReader;l.readAsDataURL(s),l.onload=()=>{const u=l.result.split(",")[1];e(u)},l.onerror=d=>k(d)}),x=s=>s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":s<1024*1024*1024?(s/(1024*1024)).toFixed(2)+" MB":(s/(1024*1024*1024)).toFixed(2)+" GB",A=()=>{o.clearMessages()},D=s=>{const e=new Date(s);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},F=()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)},O=()=>{C.value=!C.value},E=()=>{b.value=!b.value};return(s,e)=>{const k=w("el-empty"),l=w("el-icon"),d=w("el-input"),u=w("el-button"),H=w("el-upload"),K=w("el-card");return v(),h("div",le,[t(K,{class:"chat-card"},{header:i(()=>[n("div",ie,[e[1]||(e[1]=n("h2",null,"AI教学助手",-1)),n("div",ce,[n("div",{class:z(["status-indicator",{connected:p(o).isConnected}])},null,2),n("span",null,_(p(o).isConnected?"已连接":"未连接"),1)])])]),default:i(()=>[n("div",{class:"messages-container",ref_key:"messagesContainer",ref:m},[p(o).messages.length===0?(v(),h("div",re,[t(k,{description:"暂无对话记录，开始提问吧！"})])):(v(!0),h(q,{key:1},G(p(o).messages,(f,we)=>(v(),h("div",{key:f.id,class:z(["message",f.role==="user"?"user-message":"ai-message"])},[n("strong",null,_(f.role==="user"?"您":"AI教学助手"),1),f.file?(v(),h("div",de,[t(l,null,{default:i(()=>[t(p(oe))]),_:1}),n("span",null,_(f.file.name)+" ("+_(x(f.file.size))+")",1)])):W("",!0),n("div",{innerHTML:f.content},null,8,ue),n("span",pe,_(D(f.timestamp)),1)],2))),128)),y.value?(v(),h("div",fe,[e[2]||(e[2]=n("strong",null,"AI教学助手",-1)),e[3]||(e[3]=n("div",{class:"typing-indicator"},[n("span",{class:"typing-dot"}),n("span",{class:"typing-dot"}),n("span",{class:"typing-dot"})],-1)),n("span",me,_(D(Date.now())),1)])):W("",!0)],512),n("div",ge,[t(d,{modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=f=>a.value=f),type:"textarea",rows:3,placeholder:"输入您的问题...",onKeyup:j(Q(T,["ctrl"]),["enter"])},null,8,["modelValue","onKeyup"]),r.value?(v(),h("div",he,[n("div",_e,[n("span",null,_(r.value.name),1),t(u,{type:"text",onClick:$,class:"remove-file-btn"},{default:i(()=>[t(l,null,{default:i(()=>[t(p(X))]),_:1})]),_:1})])])):W("",!0),n("div",ve,[t(H,{class:"upload-button","auto-upload":!1,"show-file-list":!1,"on-change":N,limit:1},{default:i(()=>[t(u,{plain:""},{default:i(()=>[t(l,null,{default:i(()=>[t(p(Y))]),_:1}),e[4]||(e[4]=S(" 上传文件 "))]),_:1})]),_:1}),t(u,{type:C.value?"primary":"default",plain:"",onClick:O},{default:i(()=>[t(l,null,{default:i(()=>[t(p(Z))]),_:1}),e[5]||(e[5]=S(" 深度思考 "))]),_:1},8,["type"]),t(u,{type:b.value?"primary":"default",plain:"",onClick:E},{default:i(()=>[t(l,null,{default:i(()=>[t(p(ee))]),_:1}),e[6]||(e[6]=S(" 联网搜索 "))]),_:1},8,["type"]),t(u,{type:"primary",onClick:T,disabled:!p(o).isConnected||y.value},{default:i(()=>[t(l,null,{default:i(()=>[t(p(te))]),_:1}),e[7]||(e[7]=S(" 发送 "))]),_:1},8,["disabled"]),t(u,{onClick:A},{default:i(()=>[t(l,null,{default:i(()=>[t(p(se))]),_:1}),e[8]||(e[8]=S(" 清空对话 "))]),_:1})])])]),_:1})])}}}),Se=ne(ke,[["__scopeId","data-v-37ec339b"]]);export{Se as default};
